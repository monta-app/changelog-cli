name: Release new version
on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  create-tag-and-build:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.create_tag.outputs.new_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all tags
      - name: Create new version tag
        id: create_tag
        run: |
          # Configure git committer
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Get the latest tag
          LATEST_TAG=$(git tag --sort=-version:refname | head -n 1)
          echo "Latest tag: $LATEST_TAG"

          # Parse version numbers (assuming format vMAJOR.MINOR.PATCH)
          VERSION=${LATEST_TAG#v}  # Remove 'v' prefix
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Determine version bump type (default to patch for push events)
          BUMP_TYPE="${{ inputs.version_bump || 'patch' }}"
          echo "Version bump type: $BUMP_TYPE"

          # Increment version based on bump type
          case "$BUMP_TYPE" in
            major)
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="v${NEW_MAJOR}.0.0"
              ;;
            minor)
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="v${MAJOR}.${NEW_MINOR}.0"
              ;;
            patch)
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
              ;;
          esac

          echo "Creating new tag: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Create annotated tag
          git tag "$NEW_VERSION" -m "Release $NEW_VERSION" -a

          # Push the tag
          git push origin "$NEW_VERSION"

          echo "âœ… Successfully created and pushed tag $NEW_VERSION"
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: 'gradle'
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install libcurl4-openssl-dev
      - name: Build with Gradle
        run: ./gradlew commonBinaries
      - name: Move and apply correct permissions to binary
        run: |
          cp build/bin/common/releaseExecutable/changelog-cli.kexe ./changelog-cli
          chmod +x ./changelog-cli
      - name: Upload executable
        uses: actions/upload-artifact@v6
        with:
          name: changelog-cli
          path: changelog-cli

  create-release:
    runs-on: ubuntu-latest
    needs: create-tag-and-build
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Download a single artifact
        uses: actions/download-artifact@v7
        with:
          name: changelog-cli
      - name: Give artifact correct permissions
        run: chmod +x ./changelog-cli
      - name: Run changelog
        id: changelog
        run: ./changelog-cli
        env:
          CHANGELOG_SERVICE_NAME: "Changelog Generator"
          CHANGELOG_GITHUB_RELEASE: true
          CHANGELOG_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGELOG_JIRA_APP_NAME: "montaapp"
          CHANGELOG_VERSION_MODE: "SemVer"
          CHANGELOG_OUTPUT: "slack"
          CHANGELOG_SLACK_TOKEN: ${{ secrets.SLACK_APP_TOKEN }}
          CHANGELOG_SLACK_CHANNEL_NAME: "C02PDBL6GAU"
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: changelog-cli
          asset_name: changelog-cli
          tag: ${{ needs.create-tag-and-build.outputs.new_version }}
          overwrite: true
