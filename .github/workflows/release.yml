name: Release new version
on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  create-tag-and-build:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.create_tag.outputs.new_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all tags
      - name: Create new version tag
        id: create_tag
        run: |
          # Configure git committer
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Get the latest tag
          LATEST_TAG=$(git tag --sort=-version:refname | head -n 1)
          echo "Latest tag: $LATEST_TAG"

          # Parse version numbers (assuming format vMAJOR.MINOR.PATCH)
          VERSION=${LATEST_TAG#v}  # Remove 'v' prefix
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          # Determine version bump type (default to patch for push events)
          BUMP_TYPE="${{ inputs.version_bump || 'patch' }}"
          echo "Version bump type: $BUMP_TYPE"

          # Increment version based on bump type
          case "$BUMP_TYPE" in
            major)
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="v${NEW_MAJOR}.0.0"
              ;;
            minor)
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="v${MAJOR}.${NEW_MINOR}.0"
              ;;
            patch)
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
              ;;
          esac

          echo "Creating new tag: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

          # Create annotated tag
          git tag "$NEW_VERSION" -m "Release $NEW_VERSION" -a

          # Push the tag
          git push origin "$NEW_VERSION"

          echo "âœ… Successfully created and pushed tag $NEW_VERSION"
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: 'gradle'
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install libcurl4-openssl-dev
      - name: Build with Gradle
        run: ./gradlew prepareReleaseBinaries
      - name: Upload x64 executable
        uses: actions/upload-artifact@v6
        with:
          name: changelog-cli-x64
          path: build/release/changelog-cli-x64
      - name: Upload ARM64 executable
        uses: actions/upload-artifact@v6
        with:
          name: changelog-cli-arm64
          path: build/release/changelog-cli-arm64

  create-release:
    runs-on: ubuntu-latest
    needs: create-tag-and-build
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Download x64 artifact
        uses: actions/download-artifact@v7
        with:
          name: changelog-cli-x64
          path: ./binaries
      - name: Download ARM64 artifact
        uses: actions/download-artifact@v7
        with:
          name: changelog-cli-arm64
          path: ./binaries
      - name: Give artifacts correct permissions
        run: |
          chmod +x ./binaries/changelog-cli-x64
          chmod +x ./binaries/changelog-cli-arm64
      - name: Run changelog (using x64 binary)
        id: changelog
        run: ./binaries/changelog-cli-x64
        env:
          CHANGELOG_SERVICE_NAME: "Changelog Generator"
          CHANGELOG_GITHUB_RELEASE: true
          CHANGELOG_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGELOG_JIRA_APP_NAME: "montaapp"
          CHANGELOG_VERSION_MODE: "SemVer"
          CHANGELOG_OUTPUT: "slack"
          CHANGELOG_SLACK_TOKEN: ${{ secrets.SLACK_APP_TOKEN }}
          CHANGELOG_SLACK_CHANNEL_NAME: "C02PDBL6GAU"
      - name: Upload x64 binary to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./binaries/changelog-cli-x64
          asset_name: changelog-cli-x64
          tag: ${{ needs.create-tag-and-build.outputs.new_version }}
          overwrite: true
      - name: Upload ARM64 binary to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./binaries/changelog-cli-arm64
          asset_name: changelog-cli-arm64
          tag: ${{ needs.create-tag-and-build.outputs.new_version }}
          overwrite: true

  update-action-repo:
    runs-on: ubuntu-latest
    needs: [create-release, create-tag-and-build]
    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_MONTA_BOT }}
      - name: Checkout changelog-cli-action
        uses: actions/checkout@v6
        with:
          repository: monta-app/changelog-cli-action
          ssh-key: ${{ secrets.SSH_KEY_MONTA_BOT }}
          fetch-depth: 0
      - name: Update version in action.yml
        run: |
          VERSION="${{ needs.create-tag-and-build.outputs.new_version }}"
          sed -i "s|releases/download/v[0-9]*\.[0-9]*\.[0-9]*|releases/download/$VERSION|g" action.yml

          # Show the diff
          git diff action.yml
      - name: Create or update PR
        env:
          GH_TOKEN: ${{ secrets.MONTA_BOT_TOKEN }}
        run: |
          VERSION="${{ needs.create-tag-and-build.outputs.new_version }}"
          BRANCH_NAME="chore/update-cli-version"

          # Configure git with Monta Bot credentials
          git config user.name "Monta Bot"
          git config user.email "bot@monta.app"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' || echo "")

          # Always start from main and create/update the branch
          git checkout -B "$BRANCH_NAME"
          git add action.yml
          git commit -m "chore: update changelog-cli to $VERSION"
          git push origin "$BRANCH_NAME" --force

          # Prepare PR body
          PR_BODY=$(cat <<EOF
          Automatically generated PR to update changelog-cli version.

          ## Changes
          - Update changelog-cli to **$VERSION**

          ## Release Notes
          See the [changelog-cli $VERSION release](https://github.com/monta-app/changelog-cli/releases/tag/$VERSION) for details.

          ðŸ¤– Automated by changelog-cli release workflow
          _Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')_
          EOF
          )

          if [ -n "$EXISTING_PR" ]; then
            echo "Found existing PR #$EXISTING_PR, updating it..."

            gh pr edit "$EXISTING_PR" \
              --title "chore: update changelog-cli to $VERSION" \
              --body "$PR_BODY"

            echo "âœ… Updated existing PR #$EXISTING_PR"
          else
            echo "No existing PR found, creating new one..."

            gh pr create \
              --title "chore: update changelog-cli to $VERSION" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME"

            echo "âœ… Created new PR"
          fi
